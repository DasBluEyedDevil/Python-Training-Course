{
  "lesson_id": "13_03",
  "title": "Database Integration with SQLite",
  "module_id": 13,
  "order_index": 3,
  "description": "Learn to integrate SQLite databases with Flask APIs. Perform CRUD operations, use context managers for connections, and build data-persistent applications.",
  "estimated_minutes": 40,
  "content_blocks": [
    {
      "type": "the_simplifier",
      "title": "The Concept: Persistent Data Storage",
      "content": "**Databases = Permanent data storage**\n\n**Without database:**\n```python\nusers = []  # Lost when server restarts!\n```\n\n**With database:**\n```python\n# Data persists between restarts\nusers = db.get_all_users()\n```\n\n**Why SQLite?**\n- ✅ Built into Python (no installation)\n- ✅ File-based (easy to use)\n- ✅ Perfect for learning\n- ✅ Great for small/medium apps\n- ✅ No server needed\n\n**SQL Basics:**\n\n**CREATE** - Make tables\n```sql\nCREATE TABLE users (\n    id INTEGER PRIMARY KEY,\n    name TEXT,\n    email TEXT UNIQUE\n)\n```\n\n**INSERT** - Add data\n```sql\nINSERT INTO users (name, email) VALUES ('Alice', 'alice@example.com')\n```\n\n**SELECT** - Read data\n```sql\nSELECT * FROM users WHERE id = 1\n```\n\n**UPDATE** - Modify data\n```sql\nUPDATE users SET name = 'Bob' WHERE id = 1\n```\n\n**DELETE** - Remove data\n```sql\nDELETE FROM users WHERE id = 1\n```"
    },
    {
      "type": "the_coder",
      "title": "Code Example: SQLite Basics",
      "code": "import sqlite3\nimport os\n\nprint(\"=== Creating Database ===\")\n\n# Remove old database if exists\nif os.path.exists('example.db'):\n    os.remove('example.db')\n\n# Connect to database (creates if doesn't exist)\nconn = sqlite3.connect('example.db')\ncursor = conn.cursor()\n\nprint(\"Database created: example.db\")\n\nprint(\"\\n=== Creating Table ===\")\n\ncursor.execute('''\n    CREATE TABLE users (\n        id INTEGER PRIMARY KEY AUTOINCREMENT,\n        name TEXT NOT NULL,\n        email TEXT UNIQUE NOT NULL,\n        age INTEGER,\n        created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP\n    )\n''')\n\nprint(\"Table 'users' created\")\n\nprint(\"\\n=== INSERT - Adding Data ===\")\n\n# Single insert\ncursor.execute(\n    \"INSERT INTO users (name, email, age) VALUES (?, ?, ?)\",\n    ('Alice', 'alice@example.com', 25)\n)\nprint(f\"Inserted user, ID: {cursor.lastrowid}\")\n\n# Multiple inserts\nusers_data = [\n    ('Bob', 'bob@example.com', 30),\n    ('Charlie', 'charlie@example.com', 35),\n    ('Diana', 'diana@example.com', 28)\n]\n\ncursor.executemany(\n    \"INSERT INTO users (name, email, age) VALUES (?, ?, ?)\",\n    users_data\n)\nprint(f\"Inserted {cursor.rowcount} users\")\n\n# Commit changes\nconn.commit()\nprint(\"Changes committed\")\n\nprint(\"\\n=== SELECT - Reading Data ===\")\n\n# Get all users\ncursor.execute(\"SELECT * FROM users\")\nusers = cursor.fetchall()\n\nprint(f\"All users ({len(users)}):\")\nfor user in users:\n    print(f\"  ID: {user[0]}, Name: {user[1]}, Email: {user[2]}, Age: {user[3]}\")\n\n# Get specific user\ncursor.execute(\"SELECT * FROM users WHERE id = ?\", (1,))\nuser = cursor.fetchone()\nprint(f\"\\nUser #1: {user}\")\n\n# Get with WHERE clause\ncursor.execute(\"SELECT name, email FROM users WHERE age > ?\", (28,))\nolder_users = cursor.fetchall()\nprint(f\"\\nUsers older than 28:\")\nfor name, email in older_users:\n    print(f\"  {name} ({email})\")\n\nprint(\"\\n=== UPDATE - Modifying Data ===\")\n\ncursor.execute(\n    \"UPDATE users SET age = ? WHERE name = ?\",\n    (26, 'Alice')\n)\nconn.commit()\nprint(f\"Updated {cursor.rowcount} row(s)\")\n\n# Verify update\ncursor.execute(\"SELECT name, age FROM users WHERE name = 'Alice'\")\nname, age = cursor.fetchone()\nprint(f\"Alice's new age: {age}\")\n\nprint(\"\\n=== DELETE - Removing Data ===\")\n\ncursor.execute(\"DELETE FROM users WHERE id = ?\", (4,))\nconn.commit()\nprint(f\"Deleted {cursor.rowcount} row(s)\")\n\n# Count remaining\ncursor.execute(\"SELECT COUNT(*) FROM users\")\ncount = cursor.fetchone()[0]\nprint(f\"Remaining users: {count}\")\n\nprint(\"\\n=== Using Row Factory ===\")\n\n# Make results dict-like\nconn.row_factory = sqlite3.Row\ncursor = conn.cursor()\n\ncursor.execute(\"SELECT * FROM users LIMIT 1\")\nuser = cursor.fetchone()\n\nprint(\"Accessing by column name:\")\nprint(f\"  Name: {user['name']}\")\nprint(f\"  Email: {user['email']}\")\nprint(f\"  Age: {user['age']}\")\n\n# Close connection\nconn.close()\nprint(\"\\nConnection closed\")\n\nprint(\"\\n=== Context Manager Pattern ===\")\n\ndef get_all_users():\n    \"\"\"Get all users using context manager\"\"\"\n    with sqlite3.connect('example.db') as conn:\n        conn.row_factory = sqlite3.Row\n        cursor = conn.cursor()\n        cursor.execute(\"SELECT * FROM users\")\n        return cursor.fetchall()\n\nusers = get_all_users()\nprint(f\"Retrieved {len(users)} users using context manager\")\n\n# Cleanup\nos.remove('example.db')",
      "explanation": "**SQLite key concepts:**\n\n**1. Connection:**\n```python\nconn = sqlite3.connect('database.db')\n```\n\n**2. Cursor:**\n```python\ncursor = conn.cursor()\ncursor.execute(\"SQL query\")\n```\n\n**3. Parameterized queries (prevent SQL injection):**\n```python\n# GOOD - uses placeholders\ncursor.execute(\"SELECT * FROM users WHERE id = ?\", (user_id,))\n\n# BAD - vulnerable to SQL injection\ncursor.execute(f\"SELECT * FROM users WHERE id = {user_id}\")\n```\n\n**4. Fetching results:**\n```python\ncursor.fetchone()   # Single row\ncursor.fetchall()   # All rows\ncursor.fetchmany(5) # 5 rows\n```\n\n**5. Commit changes:**\n```python\nconn.commit()  # Save INSERT/UPDATE/DELETE\n```\n\n**6. Row factory:**\n```python\nconn.row_factory = sqlite3.Row\n# Access by name: user['name']\n```",
      "output": "=== Creating Database ===\nDatabase created: example.db\n\n=== Creating Table ===\nTable 'users' created\n\n=== INSERT - Adding Data ===\nInserted user, ID: 1\nInserted 3 users\nChanges committed\n\n=== SELECT - Reading Data ===\nAll users (4):\n  ID: 1, Name: Alice, Email: alice@example.com, Age: 25\n  ID: 2, Name: Bob, Email: bob@example.com, Age: 30\n  ID: 3, Name: Charlie, Email: charlie@example.com, Age: 35\n  ID: 4, Name: Diana, Email: diana@example.com, Age: 28\n\nUser #1: (1, 'Alice', 'alice@example.com', 25, '2024-01-15 10:30:45')\n\nUsers older than 28:\n  Bob (bob@example.com)\n  Charlie (charlie@example.com)\n\n=== UPDATE - Modifying Data ===\nUpdated 1 row(s)\nAlice's new age: 26\n\n=== DELETE - Removing Data ===\nDeleted 1 row(s)\nRemaining users: 3\n\n=== Using Row Factory ===\nAccessing by column name:\n  Name: Alice\n  Email: alice@example.com\n  Age: 26\n\nConnection closed\n\n=== Context Manager Pattern ===\nRetrieved 3 users using context manager"
    },
    {
      "type": "the_simplifier",
      "title": "Syntax Breakdown",
      "content": "**Basic SQLite workflow:**\n\n```python\nimport sqlite3\n\n# 1. Connect\nconn = sqlite3.connect('database.db')\ncursor = conn.cursor()\n\n# 2. Execute SQL\ncursor.execute(\"CREATE TABLE ...\")\ncursor.execute(\"INSERT INTO ...\")\ncursor.execute(\"SELECT ...\")\n\n# 3. Fetch results (SELECT only)\nrows = cursor.fetchall()\n\n# 4. Commit changes (INSERT/UPDATE/DELETE)\nconn.commit()\n\n# 5. Close\nconn.close()\n```\n\n**With context manager (recommended):**\n\n```python\nwith sqlite3.connect('database.db') as conn:\n    cursor = conn.cursor()\n    cursor.execute(\"SELECT ...\")\n    results = cursor.fetchall()\n# Auto-commits and closes\n```\n\n**Common SQL patterns:**\n\n```sql\n-- Create table\nCREATE TABLE table_name (\n    id INTEGER PRIMARY KEY AUTOINCREMENT,\n    column1 TEXT NOT NULL,\n    column2 INTEGER DEFAULT 0\n)\n\n-- Insert\nINSERT INTO table_name (col1, col2) VALUES (?, ?)\n\n-- Select\nSELECT * FROM table_name WHERE condition\nSELECT col1, col2 FROM table_name ORDER BY col1\nSELECT * FROM table_name LIMIT 10\n\n-- Update\nUPDATE table_name SET col1 = ? WHERE id = ?\n\n-- Delete\nDELETE FROM table_name WHERE condition\n```"
    },
    {
      "type": "the_coder",
      "title": "Code Example: Flask + SQLite Integration",
      "code": "from flask import Flask, jsonify, request, g\nimport sqlite3\nimport os\n\napp = Flask(__name__)\nDATABASE = 'api.db'\n\nprint(\"=== Database Helper Functions ===\")\n\ndef get_db():\n    \"\"\"Get database connection\"\"\"\n    db = getattr(g, '_database', None)\n    if db is None:\n        db = g._database = sqlite3.connect(DATABASE)\n        db.row_factory = sqlite3.Row\n    return db\n\n@app.teardown_appcontext\ndef close_connection(exception):\n    \"\"\"Close database connection at end of request\"\"\"\n    db = getattr(g, '_database', None)\n    if db is not None:\n        db.close()\n\ndef init_db():\n    \"\"\"Initialize database with schema\"\"\"\n    with app.app_context():\n        db = get_db()\n        db.execute('''\n            CREATE TABLE IF NOT EXISTS tasks (\n                id INTEGER PRIMARY KEY AUTOINCREMENT,\n                title TEXT NOT NULL,\n                description TEXT,\n                completed BOOLEAN DEFAULT 0,\n                created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP\n            )\n        ''')\n        db.commit()\n        print(\"Database initialized\")\n\nprint(\"\\n=== API Endpoints with Database ===\")\n\n@app.route('/api/tasks', methods=['GET'])\ndef get_tasks():\n    \"\"\"Get all tasks\"\"\"\n    db = get_db()\n    cursor = db.execute('''\n        SELECT id, title, description, completed, created_at \n        FROM tasks \n        ORDER BY created_at DESC\n    ''')\n    \n    tasks = [\n        {\n            'id': row['id'],\n            'title': row['title'],\n            'description': row['description'],\n            'completed': bool(row['completed']),\n            'created_at': row['created_at']\n        }\n        for row in cursor.fetchall()\n    ]\n    \n    return jsonify({'tasks': tasks, 'count': len(tasks)})\n\n@app.route('/api/tasks/<int:task_id>', methods=['GET'])\ndef get_task(task_id):\n    \"\"\"Get specific task\"\"\"\n    db = get_db()\n    cursor = db.execute(\n        'SELECT * FROM tasks WHERE id = ?',\n        (task_id,)\n    )\n    row = cursor.fetchone()\n    \n    if not row:\n        return jsonify({'error': 'Task not found'}), 404\n    \n    task = {\n        'id': row['id'],\n        'title': row['title'],\n        'description': row['description'],\n        'completed': bool(row['completed']),\n        'created_at': row['created_at']\n    }\n    \n    return jsonify(task)\n\n@app.route('/api/tasks', methods=['POST'])\ndef create_task():\n    \"\"\"Create new task\"\"\"\n    data = request.get_json()\n    \n    if not data or 'title' not in data:\n        return jsonify({'error': 'Title is required'}), 400\n    \n    db = get_db()\n    cursor = db.execute(\n        'INSERT INTO tasks (title, description, completed) VALUES (?, ?, ?)',\n        (data['title'], data.get('description', ''), data.get('completed', False))\n    )\n    db.commit()\n    \n    # Get the created task\n    cursor = db.execute('SELECT * FROM tasks WHERE id = ?', (cursor.lastrowid,))\n    row = cursor.fetchone()\n    \n    task = {\n        'id': row['id'],\n        'title': row['title'],\n        'description': row['description'],\n        'completed': bool(row['completed']),\n        'created_at': row['created_at']\n    }\n    \n    return jsonify(task), 201\n\n@app.route('/api/tasks/<int:task_id>', methods=['PUT'])\ndef update_task(task_id):\n    \"\"\"Update task\"\"\"\n    db = get_db()\n    \n    # Check if task exists\n    cursor = db.execute('SELECT id FROM tasks WHERE id = ?', (task_id,))\n    if not cursor.fetchone():\n        return jsonify({'error': 'Task not found'}), 404\n    \n    data = request.get_json()\n    \n    # Update task\n    db.execute(\n        '''UPDATE tasks \n           SET title = ?, description = ?, completed = ?\n           WHERE id = ?''',\n        (data.get('title'), data.get('description'), \n         data.get('completed', False), task_id)\n    )\n    db.commit()\n    \n    # Return updated task\n    cursor = db.execute('SELECT * FROM tasks WHERE id = ?', (task_id,))\n    row = cursor.fetchone()\n    \n    task = {\n        'id': row['id'],\n        'title': row['title'],\n        'description': row['description'],\n        'completed': bool(row['completed']),\n        'created_at': row['created_at']\n    }\n    \n    return jsonify(task)\n\n@app.route('/api/tasks/<int:task_id>', methods=['DELETE'])\ndef delete_task(task_id):\n    \"\"\"Delete task\"\"\"\n    db = get_db()\n    cursor = db.execute('DELETE FROM tasks WHERE id = ?', (task_id,))\n    db.commit()\n    \n    if cursor.rowcount == 0:\n        return jsonify({'error': 'Task not found'}), 404\n    \n    return jsonify({'message': 'Task deleted', 'id': task_id})\n\nprint(\"\\n=== Database Class Wrapper ===\")\n\nclass TaskDatabase:\n    \"\"\"Database wrapper class\"\"\"\n    \n    def __init__(self, db_path):\n        self.db_path = db_path\n    \n    def get_connection(self):\n        conn = sqlite3.connect(self.db_path)\n        conn.row_factory = sqlite3.Row\n        return conn\n    \n    def get_all(self):\n        with self.get_connection() as conn:\n            cursor = conn.execute('SELECT * FROM tasks ORDER BY created_at DESC')\n            return [dict(row) for row in cursor.fetchall()]\n    \n    def get_by_id(self, task_id):\n        with self.get_connection() as conn:\n            cursor = conn.execute('SELECT * FROM tasks WHERE id = ?', (task_id,))\n            row = cursor.fetchone()\n            return dict(row) if row else None\n    \n    def create(self, title, description='', completed=False):\n        with self.get_connection() as conn:\n            cursor = conn.execute(\n                'INSERT INTO tasks (title, description, completed) VALUES (?, ?, ?)',\n                (title, description, completed)\n            )\n            conn.commit()\n            return cursor.lastrowid\n    \n    def update(self, task_id, title=None, description=None, completed=None):\n        with self.get_connection() as conn:\n            if title is not None:\n                conn.execute('UPDATE tasks SET title = ? WHERE id = ?', (title, task_id))\n            if description is not None:\n                conn.execute('UPDATE tasks SET description = ? WHERE id = ?', (description, task_id))\n            if completed is not None:\n                conn.execute('UPDATE tasks SET completed = ? WHERE id = ?', (completed, task_id))\n            conn.commit()\n    \n    def delete(self, task_id):\n        with self.get_connection() as conn:\n            cursor = conn.execute('DELETE FROM tasks WHERE id = ?', (task_id,))\n            conn.commit()\n            return cursor.rowcount > 0\n\nif __name__ == '__main__':\n    print(\"\\n=== Flask + SQLite API ===\")\n    print(\"Initializing database...\")\n    \n    # Remove old database\n    if os.path.exists(DATABASE):\n        os.remove(DATABASE)\n    \n    init_db()\n    \n    print(\"\\nAPI endpoints:\")\n    print(\"  GET    /api/tasks       - List all tasks\")\n    print(\"  GET    /api/tasks/<id>  - Get task\")\n    print(\"  POST   /api/tasks       - Create task\")\n    print(\"  PUT    /api/tasks/<id>  - Update task\")\n    print(\"  DELETE /api/tasks/<id>  - Delete task\")\n    print(\"\\nDatabase wrapper class also demonstrated\")\n    print(\"\\nRun with: python app.py\")\n    \n    # Cleanup\n    if os.path.exists(DATABASE):\n        os.remove(DATABASE)",
      "explanation": "**Flask + SQLite integration patterns:**\n\n**1. Connection management:**\n```python\ndef get_db():\n    # Store in Flask's g object\n    db = g._database = sqlite3.connect(DB)\n    return db\n\n@app.teardown_appcontext\ndef close_db(exception):\n    # Auto-close after request\n    db = getattr(g, '_database', None)\n    if db:\n        db.close()\n```\n\n**2. Row factory:**\n```python\ndb.row_factory = sqlite3.Row\n# Access columns by name: row['name']\n```\n\n**3. Parameterized queries:**\n```python\n# Always use placeholders (?)\ndb.execute('SELECT * FROM users WHERE id = ?', (user_id,))\n```\n\n**4. Transaction handling:**\n```python\ndb.execute('INSERT ...')\ndb.commit()  # Save changes\n```\n\n**5. Database wrapper class:**\n- Encapsulates database logic\n- Reusable across app\n- Easier to test and maintain",
      "output": "=== Database Helper Functions ===\n\n=== API Endpoints with Database ===\n\n=== Database Class Wrapper ===\n\n=== Flask + SQLite API ===\nInitializing database...\nDatabase initialized\n\nAPI endpoints:\n  GET    /api/tasks       - List all tasks\n  GET    /api/tasks/<id>  - Get task\n  POST   /api/tasks       - Create task\n  PUT    /api/tasks/<id>  - Update task\n  DELETE /api/tasks/<id>  - Delete task\n\nDatabase wrapper class also demonstrated\n\nRun with: python app.py"
    },
    {
      "type": "the_coder",
      "title": "Interactive Exercise",
      "instruction": "Create a database-backed Flask API for a simple notes app:\n- Table: notes (id, title, content, created_at)\n- Endpoints: GET all, GET by id, POST create, DELETE\n- Use context manager for database connections\n- Return proper status codes",
      "starter_code": "from flask import Flask, jsonify, request\nimport sqlite3\n\napp = Flask(__name__)\nDATABASE = 'notes.db'\n\n# TODO: Initialize database with notes table\n\n# TODO: Implement GET /api/notes\n\n# TODO: Implement GET /api/notes/<id>\n\n# TODO: Implement POST /api/notes\n\n# TODO: Implement DELETE /api/notes/<id>\n\nif __name__ == '__main__':\n    app.run(debug=True)",
      "hint": "Use 'with sqlite3.connect(DATABASE) as conn:' for connections. Set row_factory to sqlite3.Row. Use execute with placeholders (?)."
    },
    {
      "type": "the_coder",
      "title": "Solution",
      "solution_code": "from flask import Flask, jsonify, request\nimport sqlite3\nimport os\nfrom datetime import datetime\n\napp = Flask(__name__)\nDATABASE = 'notes.db'\n\ndef init_db():\n    \"\"\"Initialize database\"\"\"\n    with sqlite3.connect(DATABASE) as conn:\n        conn.execute('''\n            CREATE TABLE IF NOT EXISTS notes (\n                id INTEGER PRIMARY KEY AUTOINCREMENT,\n                title TEXT NOT NULL,\n                content TEXT,\n                created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP\n            )\n        ''')\n        conn.commit()\n\ndef get_db_connection():\n    \"\"\"Get database connection with row factory\"\"\"\n    conn = sqlite3.connect(DATABASE)\n    conn.row_factory = sqlite3.Row\n    return conn\n\n@app.route('/api/notes', methods=['GET'])\ndef get_notes():\n    \"\"\"Get all notes\"\"\"\n    with get_db_connection() as conn:\n        cursor = conn.execute('''\n            SELECT id, title, content, created_at \n            FROM notes \n            ORDER BY created_at DESC\n        ''')\n        notes = [\n            {\n                'id': row['id'],\n                'title': row['title'],\n                'content': row['content'],\n                'created_at': row['created_at']\n            }\n            for row in cursor.fetchall()\n        ]\n    \n    return jsonify({'notes': notes, 'count': len(notes)})\n\n@app.route('/api/notes/<int:note_id>', methods=['GET'])\ndef get_note(note_id):\n    \"\"\"Get specific note\"\"\"\n    with get_db_connection() as conn:\n        cursor = conn.execute(\n            'SELECT * FROM notes WHERE id = ?',\n            (note_id,)\n        )\n        row = cursor.fetchone()\n    \n    if not row:\n        return jsonify({'error': 'Note not found'}), 404\n    \n    note = {\n        'id': row['id'],\n        'title': row['title'],\n        'content': row['content'],\n        'created_at': row['created_at']\n    }\n    \n    return jsonify(note)\n\n@app.route('/api/notes', methods=['POST'])\ndef create_note():\n    \"\"\"Create new note\"\"\"\n    data = request.get_json()\n    \n    # Validation\n    if not data or 'title' not in data:\n        return jsonify({'error': 'Title is required'}), 400\n    \n    if not data['title'].strip():\n        return jsonify({'error': 'Title cannot be empty'}), 400\n    \n    with get_db_connection() as conn:\n        cursor = conn.execute(\n            'INSERT INTO notes (title, content) VALUES (?, ?)',\n            (data['title'], data.get('content', ''))\n        )\n        conn.commit()\n        note_id = cursor.lastrowid\n        \n        # Get the created note\n        cursor = conn.execute('SELECT * FROM notes WHERE id = ?', (note_id,))\n        row = cursor.fetchone()\n    \n    note = {\n        'id': row['id'],\n        'title': row['title'],\n        'content': row['content'],\n        'created_at': row['created_at']\n    }\n    \n    return jsonify(note), 201\n\n@app.route('/api/notes/<int:note_id>', methods=['PUT'])\ndef update_note(note_id):\n    \"\"\"Update note\"\"\"\n    data = request.get_json()\n    \n    if not data:\n        return jsonify({'error': 'No data provided'}), 400\n    \n    with get_db_connection() as conn:\n        # Check if note exists\n        cursor = conn.execute('SELECT id FROM notes WHERE id = ?', (note_id,))\n        if not cursor.fetchone():\n            return jsonify({'error': 'Note not found'}), 404\n        \n        # Update note\n        conn.execute(\n            'UPDATE notes SET title = ?, content = ? WHERE id = ?',\n            (data.get('title'), data.get('content'), note_id)\n        )\n        conn.commit()\n        \n        # Get updated note\n        cursor = conn.execute('SELECT * FROM notes WHERE id = ?', (note_id,))\n        row = cursor.fetchone()\n    \n    note = {\n        'id': row['id'],\n        'title': row['title'],\n        'content': row['content'],\n        'created_at': row['created_at']\n    }\n    \n    return jsonify(note)\n\n@app.route('/api/notes/<int:note_id>', methods=['DELETE'])\ndef delete_note(note_id):\n    \"\"\"Delete note\"\"\"\n    with get_db_connection() as conn:\n        cursor = conn.execute('DELETE FROM notes WHERE id = ?', (note_id,))\n        conn.commit()\n    \n    if cursor.rowcount == 0:\n        return jsonify({'error': 'Note not found'}), 404\n    \n    return jsonify({'message': 'Note deleted successfully', 'id': note_id})\n\n@app.route('/api/notes/search', methods=['GET'])\ndef search_notes():\n    \"\"\"Search notes by keyword\"\"\"\n    keyword = request.args.get('q', '')\n    \n    if not keyword:\n        return jsonify({'error': 'Search query required'}), 400\n    \n    with get_db_connection() as conn:\n        cursor = conn.execute(\n            '''SELECT * FROM notes \n               WHERE title LIKE ? OR content LIKE ?\n               ORDER BY created_at DESC''',\n            (f'%{keyword}%', f'%{keyword}%')\n        )\n        notes = [\n            {\n                'id': row['id'],\n                'title': row['title'],\n                'content': row['content'],\n                'created_at': row['created_at']\n            }\n            for row in cursor.fetchall()\n        ]\n    \n    return jsonify({'notes': notes, 'count': len(notes), 'query': keyword})\n\n@app.route('/')\ndef home():\n    return jsonify({\n        'name': 'Notes API',\n        'version': '1.0',\n        'endpoints': {\n            'List notes': 'GET /api/notes',\n            'Get note': 'GET /api/notes/<id>',\n            'Create note': 'POST /api/notes',\n            'Update note': 'PUT /api/notes/<id>',\n            'Delete note': 'DELETE /api/notes/<id>',\n            'Search notes': 'GET /api/notes/search?q=keyword'\n        }\n    })\n\nif __name__ == '__main__':\n    print(\"=== Notes API ===\")\n    print(\"Initializing database...\")\n    \n    if os.path.exists(DATABASE):\n        os.remove(DATABASE)\n    \n    init_db()\n    print(\"Database ready!\")\n    \n    # Add sample data\n    with get_db_connection() as conn:\n        conn.execute(\"INSERT INTO notes (title, content) VALUES (?, ?)\",\n                    ('Welcome Note', 'This is your first note!'))\n        conn.execute(\"INSERT INTO notes (title, content) VALUES (?, ?)\",\n                    ('Python Tips', 'Always use virtual environments'))\n        conn.commit()\n    \n    print(\"Sample notes added\")\n    print(\"\\nAPI ready on http://localhost:5000\")\n    print(\"\\nEndpoints:\")\n    print(\"  GET    /api/notes\")\n    print(\"  GET    /api/notes/<id>\")\n    print(\"  POST   /api/notes\")\n    print(\"  PUT    /api/notes/<id>\")\n    print(\"  DELETE /api/notes/<id>\")\n    print(\"  GET    /api/notes/search?q=keyword\")\n    \n    # Cleanup\n    os.remove(DATABASE)",
      "explanation": "**Complete notes API with SQLite:**\n\n**Features:**\n1. **Database initialization** - Creates table if not exists\n2. **Connection management** - Context manager pattern\n3. **Full CRUD** - Create, Read, Update, Delete\n4. **Validation** - Check required fields\n5. **Search functionality** - LIKE queries\n6. **Proper status codes** - 200, 201, 404, 400\n7. **Row factory** - Dict-like access to results\n\n**Best practices:**\n- Parameterized queries (prevent SQL injection)\n- Context managers (auto-close connections)\n- Validation before database operations\n- Clear error messages\n- Consistent response format\n\n**Security notes:**\n- Never use f-strings for SQL queries\n- Always validate input\n- Use transactions for multiple operations\n- Handle errors gracefully",
      "output": "=== Notes API ===\nInitializing database...\nDatabase ready!\nSample notes added\n\nAPI ready on http://localhost:5000\n\nEndpoints:\n  GET    /api/notes\n  GET    /api/notes/<id>\n  POST   /api/notes\n  PUT    /api/notes/<id>\n  DELETE /api/notes/<id>\n  GET    /api/notes/search?q=keyword",
      "common_mistakes": [
        "Forgetting to commit changes - conn.commit() is required",
        "Not closing connections - use context manager (with statement)",
        "SQL injection - never use f-strings, always use placeholders (?)",
        "Not setting row_factory - makes results harder to work with",
        "Forgetting error handling - check if row exists before updating/deleting"
      ]
    },
    {
      "type": "key_takeaways",
      "title": "Key Takeaways",
      "takeaways": [
        "**SQLite is file-based** - No server needed, perfect for small apps",
        "**Use placeholders (?)** - Prevent SQL injection, never use f-strings",
        "**Context managers for connections** - with sqlite3.connect() as conn:",
        "**Commit changes** - conn.commit() after INSERT/UPDATE/DELETE",
        "**Row factory for dict-like access** - conn.row_factory = sqlite3.Row",
        "**Validate before database ops** - Check required fields first",
        "**fetchone() vs fetchall()** - one() for single row, all() for multiple",
        "**AUTOINCREMENT for IDs** - Let database handle ID generation"
      ]
    }
  ],
  "checkpoint_quiz": {
    "questions": [
      {
        "id": 1,
        "type": "multiple_choice",
        "question": "How do you prevent SQL injection in SQLite queries?",
        "options": [
          "Use f-strings for queries",
          "Use placeholders (?) and parameters",
          "Validate input first",
          "Use string concatenation"
        ],
        "correct_answer": 1,
        "explanation": "Use placeholders (?) and pass values as parameters: cursor.execute('SELECT * WHERE id = ?', (id,)). Never use f-strings or concatenation."
      },
      {
        "id": 2,
        "type": "multiple_choice",
        "question": "What does conn.commit() do?",
        "options": [
          "Closes the connection",
          "Saves changes to the database",
          "Executes a query",
          "Fetches results"
        ],
        "correct_answer": 1,
        "explanation": "conn.commit() saves (commits) changes made by INSERT, UPDATE, or DELETE operations. Without it, changes are lost."
      },
      {
        "id": 3,
        "type": "multiple_choice",
        "question": "What's the benefit of setting row_factory to sqlite3.Row?",
        "options": [
          "Makes queries faster",
          "Allows accessing columns by name like a dictionary",
          "Automatically commits changes",
          "Creates the database schema"
        ],
        "correct_answer": 1,
        "explanation": "Setting row_factory = sqlite3.Row allows accessing columns by name (row['name']) instead of index (row[0])."
      }
    ]
  }
}
